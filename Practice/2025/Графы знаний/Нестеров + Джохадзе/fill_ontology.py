from rdflib import Graph, Namespace, URIRef, Literal
from rdflib.namespace import RDF, RDFS, OWL
from pathlib import Path
from urllib.parse import quote
import uuid
import re

input_path = Path("alchemy_clean.rdf")
output_path = Path("alchemy_full.rdf")

g = Graph()
g.parse(str(input_path), format="xml")

BASE = "http://example.org/alchemy#"
EX = Namespace(BASE)

CLASS_ELEMENT = EX.Element
CLASS_BASIC = EX.BasicElement
CLASS_CREATED = EX.CreatedElement
CLASS_RECIPE = EX.Recipe

PROP_ING = EX.hasIngredient
PROP_RES = EX.hasResult

g.add((PROP_ING, RDF.type, OWL.ObjectProperty))
g.add((PROP_RES, RDF.type, OWL.ObjectProperty))


def clean_uri_fragment(label: str) -> str:
    s = label.strip()
    s = s.replace(" ", "_")
    s = re.sub(r"[()\/,\.:;\"']", "", s)
    return quote(s, safe="_%-~")


def find_individual_by_label(graph: Graph, label: str) -> URIRef | None:
    lit = Literal(label, lang="ru")
    for s in graph.subjects(RDFS.label, lit):
        return s
    for s in graph.subjects(RDFS.label, Literal(label)):
        return s
    return None


def get_or_create_individual(graph: Graph, label: str) -> URIRef:
    existing = find_individual_by_label(graph, label)
    if existing:
        return existing
    frag = clean_uri_fragment(label)
    uri = EX[frag]
    if any(graph.triples((uri, None, None))):
        uri = EX[frag + "_" + uuid.uuid4().hex[:8]]
    graph.add((uri, RDF.type, OWL.NamedIndividual))
    graph.add((uri, RDFS.label, Literal(label, lang="ru")))
    return uri


def ensure_type(graph: Graph, individual: URIRef, class_uri: URIRef):
    if not any(graph.triples((individual, RDF.type, class_uri))):
        graph.add((individual, RDF.type, class_uri))

mappings = [
    ("Водка", "Сок", "Коктейль"), ("Бактерия", "Бактерия", "Клетки"), ("Спирт", "Ягода", "Ликёр"),
    ("Ром", "Молоко", "Пина колада"), ("Трава", "Фрукт", "Банан"), ("Трава", "Земля", "Бамбук"),
    ("Трава", "Дерево", "Лиана"), ("Планктон", "Вода", "Медуза"), ("Планктон", "Песок", "Морская звезда"),
    ("Планктон", "Земля", "Членистоногие"), ("Планктон", "Болото", "Моллюски"), ("Моллюски", "Болото", "Слизни"),
    ("Моллюски", "Песок", "Мидии"), ("Моллюски", "Вода", "Головоногие"), ("Головоногие", "Вода", "Осьминог"),
    ("Головоногие", "Песок", "Аммониты"), ("Воздух", "Жук", "Насекомые"), ("Насекомые", "Земля", "Муравьи"),
    ("Насекомые", "Вода", "Стрекоза"), ("Муравьи", "Древесина", "Термиты"), ("Папоротник", "Песок", "Пальма"),
    ("Металл", "Радиация", "Уран"), ("Пиво", "Великобритания", "Эль"), ("Давление", "Серебро", "Монета"),
    ("Монета", "Бумага", "Деньги"), ("Членистоногие", "Камень", "Паук"), ("Куст", "Индия", "Чай"),
    ("Учёный", "Солнце", "Звезда"), ("Звезда", "Небо", "Космос"), ("Пашня", "Цветок", "Лён"),
    ("Космос", "Самолёт", "Шаттл"), ("Хлеб", "Огонь", "Гренки"), ("Страна", "Дерево", "Канада"),
    ("Страна", "Холод", "Гренландия"), ("Птица", "Радуга", "Попугай"), ("Птица", "Древесина", "Дятел"),
    ("Птица", "Цветок", "Колибри"), ("Пчела", "Цветок", "Мед"), ("Человек", "Шерсть", "Обезьяна"),
    ("Больница", "Машина", "Скорая помощь"), ("Континент", "континент", "Планета"),
    ("Страна", "Кенгуру", "Австралия"), ("Страна", "Картофель", "Беларусь"),
    ("Страна", "Робин Гуд", "Великобритания"), ("Страна", "Фольксваген Жук", "Германия"),
    ("Страна", "Камасутра", "Индия"), ("Страна", "Вулкан", "Исландия"), ("Страна", "Пицца", "Италия"),
    ("Страна", "Дракон", "Китай"), ("Страна", "Медведь", "Россия"), ("Страна", "Вампир", "Трансильвания"),
    ("Страна", "Трансильвания", "Румыния"), ("Страна", "Нефть", "Саудовская Аравия"), ("Страна", "Сало", "Украина"),
    ("Страна", "Сауна", "Финляндия"), ("Страна", "Шампанское", "Франция"), ("Страна", "Часы", "Швейцария"),
    ("Страна", "Суши", "Япония"), ("Страна", "Текила", "Мексика"), ("Мексика", "Семена", "Какао"),
    ("Какао", "Сахар", "Шоколад"), ("Индия", "Зверь", "Слон"), ("Яд", "Шаман", "Лекарство"),
    ("Яд", "Оружие", "Отравленное оружие"), ("Яд", "Рыба", "Фугу"), ("Яд", "Человек", "Труп"),
    ("Труп", "Жизнь", "Зомби"), ("Труп", "Ткань", "Мумия"), ("Мумия", "Страна", "Египет"),
    ("Огонь", "Бензин", "Взрыв"), ("Огонь", "Древесина", "Углерод"), ("Хлеб", "Бактерия", "Дрожжи"),
    ("Вода", "Дрожжи", "Самогон"), ("Вода", "Сахар", "Сладкая вода"), ("Вода", "Соль", "Солёная вода"),
    ("Вода", "Трава", "Камыш"), ("Вода", "Самолёт", "Гидроплан"), ("Облако", "Ветер", "Холод"),
    ("Холод", "Вода", "Лёд"), ("Птица", "Лёд", "Пингвин"), ("Подсолнух", "Давление", "Подсолнечное масло"),
    ("Охотник", "Мышь", "Кот"), ("Охотник", "Зверь", "Мясо"), ("Охотник", "Птица", "Перо"),
    ("Охотник", "Рыба", "Рыбак"), ("Колесница", "Небо", "Солнце"), ("Солнце", "Цветок", "Подсолнух"),
    ("Свинья", "Огонь", "Бекон"), ("Свинья", "Человек", "Жир"), ("Бумага", "Табак", "Сигареты"),
    ("Бумага", "Перо", "Книга"), ("Книга", "Любовь", "Камасутра"), ("Книга", "Книга", "Библиотека"),
    ("Библиотека", "Человек", "Учёный"), ("Учёный", "Больной", "Доктор"), ("Учёный", "Плесень", "Пенициллин"),
    ("Учёный", "Металл", "Робот"), ("Учёный", "Тростник", "Свекла"), ("Учёный", "Книга", "Философ"),
    ("Учёный", "Бомба", "Атомная бомба"), ("Атомная бомба", "Земля", "Радиация"), ("Птица", "Мышь", "Летучая мышь"),
    ("Металл", "Кислота", "Соль"), ("Соль", "Озеро", "Море"), ("Море", "Море", "Океан"),
    ("Парусник", "Убийцa", "Пират"), ("Спирт", "Пират", "Ром"), ("Город", "Город", "Страна"),
    ("Страна", "Страна", "Континент"), ("Континент", "Колумб", "Америка"), ("Камень", "Пшеница", "Мука"),
    ("Камень", "Философ", "Философский камень"), ("Философский камень", "Алюминий", "Золото"),
    ("Мука", "Вода", "Тесто"), ("Тесто", "Сыр", "Пицца"), ("Тесто", "Огонь", "Хлеб"), ("Хлеб", "Спирт", "Пиво"),
    ("Хлеб", "Мясо", "Сэндвич"), ("Жук", "Машина", "Фольксваген Жук"), ("Жук", "Навоз", "Скарабей"),
    ("Жук", "Цветок", "Пчела"), ("Жук", "Кактус", "Кошениль"), ("Огонь", "Свекла", "Борщ"),
    ("Огонь", "Кошениль", "Кармин"), ("Кармин", "Газировка", "Кока-кола"), ("Спирт", "Цветок", "Духи"),
    ("Спирт", "Пшеница", "Виски"), ("Пчела", "Цветок", "Мёд"),
    ("Деревянный корабль", "Паровой двигатель", "Пароход"), ("Папоротник", "Земля", "Куст"),
    ("Фрукт", "Куст", "Ягода"), ("Зверь", "Телега", "Упряжка"), ("Зверь", "Луна", "Волк"),
    ("Волк", "Человек", "Собака"), ("Собака", "Кот", "Котопёс"), ("Колесо", "Колесо", "Велосипед"),
    ("Колесо", "Древесина", "Телега"), ("Паровой двигатель", "Телега", "Паровоз"),
    ("Паровой двигатель", "Земля", "Трактор"), ("Трактор", "Земля", "Пашня"), ("Трактор", "Пашня", "Картофель"),
    ("Песок", "Ракушка", "Жемчуг"), ("Бактерия", "Молоко", "Кефир"), ("Бактерия", "Виноград", "Вино"),
    ("Вино", "Углекислый газ", "Шампанское"), ("Огонь", "Табак", "Дым"), ("Огонь", "Кефир", "Творог"),
    ("Огонь", "Творог", "Сыр"), ("Сыр", "Зверь", "Мышь"), ("Сыр", "Небо", "Луна"), ("Луна", "Металл", "Серебро"),
    ("Давление", "Фрукт", "Сок"), ("Давление", "Торф", "Нефть"), ("Давление", "Нефть", "Бензин"),
    ("Бензин", "Паровой двигатель", "Мотор (ДВС)"), ("Мотор (ДВС)", "Лодка", "Катер"),
    ("Мотор (ДВС)", "Телега", "Машина"), ("Мотор (ДВС)", "Велосипед", "Мотоцикл"),
    ("Вода", "Углекислый газ", "Газировка"), ("Сера", "Селитра", "Порох"), ("Порох", "Металл", "Бомба"),
    ("Порох", "Оружие", "Огнестрельное оружие"), ("Огнестрельное оружие", "Человек", "Убийцa"),
    ("Оружие", "Человек", "Охотник"), ("Оружие", "Охотник", "Воин"), ("Воин", "Зверь", "Кровь"),
    ("Воин", "Огонь", "Пожарный"), ("Воин", "Телега", "Колесница"), ("Воин", "Колесница", "Гладиатор"),
    ("Воин", "Дракон", "Герой"), ("Пашня", "Семена", "Горох"), ("Пашня", "Трава", "Пшеница"),
    ("Пашня", "Тростник", "Рис"), ("Лодка", "Древесина", "Деревянный корабль"),
    ("Ткань", "Деревянный корабль", "Парусник"), ("Ткань", "Лодка", "Парусная лодка"),
    ("Ткань", "Человек", "Одежда"), ("Кровь", "Человек", "Вампир"), ("Кровь", "Птица", "Гриф"),
    ("Кровь", "Червь", "Пиявка"), ("Герой", "Парусник", "Колумб"), ("Герой", "Лес", "Робин Гуд"),
    ("Домашний скот", "Грязь", "Свинья"), ("Охотник", "Свинья", "Сало"), ("Мох", "Земля", "Трава"),
    ("Гриб", "Бактерия", "Лишайник"), ("Гриб", "Грязь", "Плесень"), ("Семена", "Земля", "Дерево"),
    ("Семена", "Вода", "Цветок"), ("Инструмент", "Трава", "Газонокосилка"), ("Инструмент", "Металл", "Оружие"),
    ("Инструмент", "Время", "Часы"), ("Инструмент", "Скорпион", "Яд"), ("Инструмент", "Дерево", "Древесина"),
    ("Инструмент", "Древесина", "Колесо"), ("Инструмент", "Домашний скот", "Шерсть"),
    ("Инструмент", "Шерсть", "Ткань"), ("Земля", "Древесина", "Виноград"), ("Огонь", "Сера", "Кислота"),
    ("Огонь", "Трава", "Табак"), ("Огонь", "Дерево", "Уголь"), ("Уголь", "Паровой котёл", "Паровой двигатель"),
    ("Уголь", "Металл", "Чугун"), ("Уголь", "Давление", "Алмаз"), ("Алмаз", "Инструмент", "Бриллиант"),
    ("Вода", "Древесина", "Лодка"), ("Вода", "Вода", "Озеро"), ("Вода", "Свет", "Радуга"),
    ("Пар", "Хижина", "Сауна"), ("Свет", "Цветок", "Кислород"), ("Кислород", "Водород", "Гремучий газ"),
    ("Кислород", "Электричество", "Озон"), ("Кислород", "Человек", "Углекислый газ"),
    ("Кислород", "Спирт", "Уксус"), ("Звук", "Идея", "Музыка"), ("Трава", "Домашний скот", "Навоз"),
    ("Трава", "Болото", "Тростник"), ("Тростник", "Инструмент", "Бумага"), ("Тростник", "Давление", "Сахар"),
    ("Сахар", "Огонь", "Карамель"), ("Дерево", "Пустыня", "Кактус"), ("Дерево", "Зверь", "Панда"),
    ("Дерево", "Лампочка", "Новогодняя ёлка"), ("Дерево", "Дерево", "Роща"), ("Роща", "Роща", "Лес"),
    ("Лес", "Зверь", "Медведь"), ("Дерево", "Болото", "Торф"), ("Дерево", "Цветок", "Фрукт"),
    ("Известняк", "Навоз", "Селитра"), ("Известняк", "Глина", "Цемент"), ("Цемент", "Вода", "Бетон"),
    ("Бетон", "Кирпич", "Кирпичный дом"), ("Кирпичный дом", "Больной", "Больница"),
    ("Кирпичный дом", "Стекло", "Небоскреб"), ("Небоскреб", "Небоскреб", "Город"), ("Водоросли", "Рыба", "Суши"),
    ("Планктон", "Камень", "Ракушка"), ("Ракушка", "Камень", "Известняк"), ("Рыба", "Стекло", "Аквариум"),
    ("Рыба", "Рыба", "Икра"), ("Рыба", "Электричество", "Электрический скат"), ("Червь", "Воздух", "Бабочка"),
    ("Червь", "Земля", "Жук"), ("Червь", "Болото", "Змея"), ("Червь", "Спирт", "Текила"),
    ("Червь", "Ракушка", "Улитка"), ("Яйцо", "Земля", "Динозавр"), ("Яйцо", "Жизнь", "Курица"),
    ("Яйцо", "Воздух", "Птица"), ("Яйцо", "Огонь", "Яичница"), ("Яйцо", "Болото", "Ящерица"),
    ("Жук", "Свет", "Светлячок"), ("Жук", "Песок", "Скорпион"), ("Змея", "Электричество", "Электрический угорь"),
    ("Динозавр", "Огонь", "Дракон"), ("Динозавр", "Воздух", "Птеродактиль"), ("Курица", "Огонь", "Курица-гриль"),
    ("Птица", "Металл", "Самолёт"), ("Птица", "Огонь", "Феникс"), ("Ящерица", "Земля", "Зверь"),
    ("Ящерица", "Болото", "Лягушка"), ("Ящерица", "Огонь", "Саламандра"), ("Скорпион", "Вода", "Лобстер"),
    ("Зверь", "Плотина", "Бобр"), ("Зверь", "Пустыня", "Верблюд"), ("Зверь", "Лягушка", "Кенгуру"),
    ("Зверь", "Вода", "Кит"), ("Зверь", "Жизнь", "Человек"), ("Металл", "Кит", "Субмарина"),
    ("Металл", "Самолёт", "Алюминий"), ("Человек", "Спирт", "Алкоголик"), ("Человек", "Грипп", "Больной"),
    ("Человек", "Зверь", "Домашний скот"), ("Человек", "Домашний скот", "молоко"), ("Человек", "Лампочка", "Идея"),
    ("Человек", "Металл", "Инструмент"), ("Человек", "Глина", "Керамика"), ("Человек", "Самолёт", "Пилот"),
    ("Человек", "Человек", "Любовь"), ("Человек", "Камень", "Хижина"), ("Человек", "Гриб", "Шаман"),
    ("Мох", "Болото", "Папоротник"),
]

for a_label, b_label, prod_label in mappings:
    a_ind = get_or_create_individual(g, a_label)
    b_ind = get_or_create_individual(g, b_label)
    prod_ind = get_or_create_individual(g, prod_label)

    ensure_type(g, prod_ind, CLASS_CREATED)
    ensure_type(g, prod_ind, CLASS_ELEMENT)

    slug = f"{clean_uri_fragment(a_label)}_{clean_uri_fragment(b_label)}"
    recipe_uri = EX["Recipe_" + slug + "_" + uuid.uuid4().hex[:8]]
    recipe_label = f"{a_label} + {b_label} = {prod_label}"

    g.add((recipe_uri, RDF.type, OWL.NamedIndividual))
    g.add((recipe_uri, RDF.type, CLASS_RECIPE))
    g.add((recipe_uri, RDFS.label, Literal(recipe_label, lang="ru")))

    g.add((recipe_uri, PROP_ING, a_ind))
    g.add((recipe_uri, PROP_ING, b_ind))

    g.add((recipe_uri, PROP_RES, prod_ind))

g.serialize(destination=str(output_path), format="pretty-xml")
print(f"Готово. Сохранено: {output_path}")
